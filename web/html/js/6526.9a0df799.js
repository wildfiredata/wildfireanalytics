"use strict";(self["webpackChunkwildfire"]=self["webpackChunkwildfire"]||[]).push([[6526],{66526:function(e,t,s){s.r(t),s.d(t,{default:function(){return S}});var a=function(){var e=this,t=e._self._c;return t("div",{staticClass:"root"},[t("div",{staticClass:"maintitle"},[e._v(e._s(e.$t("message.埋点方案")))]),t("div",{staticClass:"workerea"},[t("div",[t("div",{staticClass:"sectiontitle"},[e._v(e._s(e.$t("message.上传埋点方案")))]),t("div",{staticClass:"upload_tool_bar"},[t("el-button",{staticClass:"ml10",attrs:{size:"mini",icon:"el-icon-download"},on:{click:e.on_click_download}},[e._v(e._s(e.$t("message.下载事件埋点表")))]),t("el-button",{staticClass:"ml10",attrs:{size:"mini",type:"primary"},on:{click:e.on_click_upload}},[e._v(e._s(e.$t("message.添加埋点方案"))),t("i",{staticClass:"el-icon-upload el-icon--right"})])],1)]),t("div",[t("div",{staticClass:"sectiontitle"},[e._v(e._s(e.$t("message.埋点上报入库规则")))]),t("div",{staticClass:"putdbpolicy"},[t("div",[t("el-radio-group",{on:{input:e.setAppCollectStyle},model:{value:e.collectStyle,callback:function(t){e.collectStyle=t},expression:"collectStyle"}},[t("el-radio",{attrs:{size:"small",label:"free",border:""}},[e._v(e._s(e.$t("message.开启自由上报模式")))]),t("el-radio",{attrs:{size:"small",label:"mandatory",border:""}},[e._v(e._s(e.$t("message.开启强制校验上报模式")))])],1)],1),"free"==e.collectStyle?t("b-message",{staticClass:"mt10",attrs:{type:"is-warning",size:"is-small"}},[e._v(" "+e._s(e.$t("message.在自由上报模式下,属性值的类,,,,,,"))+" ")]):e._e(),"mandatory"==e.collectStyle?t("b-message",{staticClass:"mt10",attrs:{type:"is-warning",size:"is-small"}},[e._v(" "+e._s(e.$t("message.在强制校验上报模式下,属性值的类,,,,,,"))+" ")]):e._e()],1)])]),t("DialogUploadEvent",{ref:"dialogupload",on:{confirm:e.on_confirm_upload}})],1)},l=[],r=s(94029),o=s(63822),i=s(8993),n=function(){var e=this,t=e._self._c;return t("div",{ref:"me",attrs:{id:"crf_deleteuserprop"}},[t("div",{attrs:{readonly:""},on:{click:function(t){e.newDialog.show=!0}}},[e._t("default")],2),t("el-dialog",{attrs:{visible:e.newDialog.show,width:"85%","show-close":!1,"close-on-click-modal":!1,"append-to-body":""},on:{"update:visible":function(t){return e.$set(e.newDialog,"show",t)}}},[t("div",{staticClass:"dialog-header",attrs:{slot:"title"},slot:"title"},[e._v(e._s(e.$t("message.添加埋点方案")))]),t("div",{staticClass:"dialogBody"},[t("b-message",{staticStyle:{"font-size":"12px"}},[e._v(" 1. "+e._s(e.$t("message.请根据【埋点表】模版完成您的事件埋点填写，上传通过校验后，方可提交至项目"))+" ")]),t("el-form",{ref:"formName",staticClass:"ruleFormClass",attrs:{"label-width":"120px"}},[t("el-upload",{ref:"uploader",attrs:{"auto-upload":!1,accept:".xls,.xlsx",action:"https://jsonplaceholder.typicode.com/posts/","on-change":e.handleupload,"on-preview":e.handlePreview,"on-remove":e.handleRemove,"on-success":e.handleSuccess,"on-err":e.handleErr,"before-remove":e.beforeRemove,multiple:"",limit:1,"on-exceed":e.handleExceed,"file-list":e.fileList}},[t("el-button",{attrs:{size:"small",type:"primary"}},[e._v(e._s(e.$t("message.点击上传excel")))])],1)],1),t("el-tabs",{attrs:{"tab-position":"left"}},[t("el-tab-pane",{attrs:{label:e.$t("message.事件属性")}},[t("el-table",{staticStyle:{width:"100%"},attrs:{border:"",data:e.events,"max-height":"400",size:"mini","row-class-name":e.changeRowCSS}},[t("el-table-column",{attrs:{resizable:"",sortable:"",prop:"id",label:e.$t("message.事件编号")}}),t("el-table-column",{attrs:{resizable:"",sortable:"",prop:"event_name",label:e.$t("message.事件英文变量名")}}),t("el-table-column",{attrs:{resizable:"",sortable:"",prop:"event_label",label:e.$t("message.事件显示名")}}),t("el-table-column",{attrs:{resizable:"",sortable:"",prop:"group_name",label:e.$t("message.事件分组名字")}}),t("el-table-column",{attrs:{resizable:"",sortable:"",prop:"prop_name",label:e.$t("message.属性英文变量名")}}),t("el-table-column",{attrs:{resizable:"",sortable:"",prop:"prop_label",label:e.$t("message.属性显示名")}}),t("el-table-column",{attrs:{resizable:"",sortable:"",prop:"data_type",label:e.$t("message.数据类型")}}),t("el-table-column",{attrs:{resizable:"",sortable:"",prop:"event_desc",label:e.$t("message.事件备注"),"show-overflow-tooltip":!0}}),t("el-table-column",{attrs:{resizable:"",sortable:"",prop:"memo",label:e.$t("message.属性备注"),"show-overflow-tooltip":!0},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(t.row.err?this.$t("message.错误信息")+":"+t.row.err:t.row.memo)+" ")]}}])})],1)],1),t("el-tab-pane",{attrs:{label:e.$t("message.用户属性")}},[t("el-table",{staticStyle:{width:"100%"},attrs:{border:"",data:e.userprops,"max-height":"400",size:"mini","row-class-name":e.changeRowCSS}},[t("el-table-column",{attrs:{resizable:"",sortable:"",prop:"prop_name",label:e.$t("message.属性英文变量名")}}),t("el-table-column",{attrs:{resizable:"",sortable:"",prop:"prop_label",label:e.$t("message.属性显示名")}}),t("el-table-column",{attrs:{resizable:"",sortable:"",prop:"data_type",label:e.$t("message.数据类型")}}),t("el-table-column",{attrs:{resizable:"",sortable:"",prop:"memo",lable:e.$t("message.备注"),"show-overflow-tooltip":!0},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(t.row.err?this.$t("message.错误信息")+":"+t.row.err:t.row.memo)+" ")]}}])})],1)],1)],1)],1),t("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("div",{staticClass:"footerwangintext"},[e._v(e._s(e.UploadDataErr))]),t("el-button",{staticClass:"dialogfooterButton",attrs:{size:"mini"},on:{click:function(t){e.newDialog.show=!1}}},[e._v(e._s(e.$t("message.取 消")))]),t("el-button",{staticClass:"dialogfooterButton",attrs:{size:"mini",disabled:e.DisableSubmit},on:{click:e.confirm}},[e._v(e._s(e.$t("message.提交")))])],1)])],1)},p=[],d=(s(57658),s(87092)),c=s(794),u={props:{},data(){return{userprops:[],events:[],rowDetail:[],fileList:[],newDialog:{show:!1},formData:{name:"",label:""},rules:{}}},created(){},mounted(){},beforeDestroy(){},methods:{showDialog(){this.newDialog.show=!0},submit(){this.$refs.uploader.submit()},confirm(){console.log("confirm"),i.Z["new"]().uploadCustomProps({events:this.events,user_props:this.userprops,app_id:this.getCurrAppId()}).then(function(e){c.Z.utils.Ignore(e),this.$emit("confirm"),this.newDialog.show=!1}.bind(this)).catch(function(e){c.Z.utils.Err(this,e)}.bind(this))},handleupload(e,t){t.length>0&&(this.events=[],this.userprops=[],this.parseExcel(e)),console.log("handleupload",e,t)},handleSuccess(e,t){console.log("handleSuccess",e,t)},parseExcel(e){if(console.log("parseExcel",e),!/\.(xls|xlsx)$/.test(e.name.toLowerCase()))return this.$modal.error({title:this.$t("message.文件格式必须为xls、xlsx")}),!1;this.handleReadExcel(e)},readUserPropSheet(e){console.log("readUserPropSheet",e);const t=e.SheetNames[1];console.log(e.SheetNames,e.Sheets[t]["!merges"]);var s=e.Sheets[t]["!merges"],a=function(e,t,s,a){var l;return e.some((e=>{if(e.s.c<=s&&e.s.r<=a&&e.e.c>=s&&e.e.r>=a)return l={c:e.s.c,r:e.s.r},!0})),l?c.Z.utils.ParseStrSafe(t[l.r][l.c]):c.Z.utils.ParseStrSafe(t[a][s])};const l=d.P6.sheet_to_json(e.Sheets[t],{header:1});console.log(t,l);for(var r=2;r<l.length;r++)l[r].length>0&&this.userprops.push({prop_name:a(s,l,0,r),prop_label:a(s,l,1,r),data_type:a(s,l,2,r),memo:a(s,l,3,r)});console.log("userprops",this.userprops),this.validateUserProp()},readEventSheet(e){const t=e.SheetNames[0];var s=e.Sheets[t]["!merges"],a=function(e,t,s,a){var l;return e.some((e=>{if(e.s.c<=s&&e.s.r<=a&&e.e.c>=s&&e.e.r>=a)return l={c:e.s.c,r:e.s.r},!0})),l?c.Z.utils.ParseStrSafe(t[l.r][l.c]):c.Z.utils.ParseStrSafe(t[a][s])};const l=d.P6.sheet_to_json(e.Sheets[t],{header:1});for(var r=2;r<l.length;r++)l[r].length>0&&this.events.push({id:a(s,l,0,r),event_name:a(s,l,1,r),event_label:a(s,l,2,r),group_name:a(s,l,3,r),prop_name:a(s,l,4,r),prop_label:a(s,l,5,r),data_type:a(s,l,6,r),event_desc:a(s,l,7,r),memo:a(s,l,8,r)});this.validateEvents()},handleReadExcel(e){const t=new FileReader;t.onload=e=>{try{const t=d.ij(e.target.result,{type:"binary"});this.readEventSheet(t),this.readUserPropSheet(t)}catch(t){c.Z.utils.Err(this,t)}},t.readAsBinaryString(e.raw)},changeRowCSS({row:e,rowIndex:t}){return c.Z.utils.Ignore(e,t),e.err?"warning-row":""},validateEvents(){var e=new Map;this.events.forEach((t=>{var s=e.get(t.event_name+","+t.prop_name);void 0===s?(e.set(t.event_name+","+t.prop_name,!0),t.err=c.Z.utils.IsValidEnglishName(t.event_name),c.Z.utils.IsEmptyStr(t.err)&&(t.err=c.Z.utils.IsValidEnglishName(t.prop_name),c.Z.utils.IsEmptyStr(t.err)&&(c.Z.def.DataType.isValidType(t.data_type)||(t.err=this.$t("message.事件属性中，出现了错误的数据类型"))))):t.err=this.$t("message.同一事件中，出现了重复的属性名字")}))},validateUserProp(){var e=new Map;this.userprops.forEach((t=>{var s=e.get(t.prop_name);void 0===s?(e.set(t.prop_name,!0),t.err=c.Z.utils.IsValidEnglishName(t.prop_name),c.Z.utils.IsEmptyStr(t.err)&&(c.Z.def.DataType.isValidType(t.data_type)||(t.err=this.$t("message.用户属性中，出现了错误的数据类型")))):t.err=this.$t("message.在自定义用户表中，出现了重复的用户属性名字")}))},handleRemove(e,t){console.log("handleRemove",e,t)},handleErr(e,t){console.log("handleErr",e,t)},handlePreview(e){console.log("handlePreview",e)},handleExceed(e,t){c.Z.utils.Ignore(e,t)},beforeRemove(e,t){c.Z.utils.Ignore(e,t)}},computed:{...(0,o.Se)({getCurrAppId:"system/getCurrAppId"}),DisableSubmit:function(){return!this.HasRecord||!!this.UploadDataErr},HasRecord:function(){return this.userprops.length>0||this.events.length>0},UploadDataErr:function(){var e;return this.events.forEach((t=>{c.Z.utils.IsEmptyStr(t.err)||(e=t.err)})),e?c.Z.utils.ParseStrSafe(e):(this.userprops.forEach((t=>{c.Z.utils.IsEmptyStr(t.err)||(e=t.err)})),e?c.Z.utils.ParseStrSafe(e):"")}}},m=u,h=s(1001),g=(0,h.Z)(m,n,p,!1,null,"f05e53de",null),_=g.exports,b=s(90948),v={components:{DialogUploadEvent:_},data(){return{collectStyle:"free"}},mounted(){this.initialize()},methods:{...(0,o.nv)({setApp:"system/setApp"}),initialize(){},on_click_download(){i.Z["new"]().GetDownloadCode({app_id:this.getCurrAppId()}).then(function(e){c.Z.utils.Ignore(e),this.another_download(e.data)}.bind(this)).catch(function(e){c.Z.utils.Err(this,e)}.bind(this))},another_download(e){var t=this.getCurrAppId();window.location.href=(0,b.cB)()+`api/saver/download_track_solution?app=${t}&code=${e}`},on_click_upload(){console.log("on_click_upload"),this.$refs.dialogupload.showDialog()},on_confirm_upload(){c.Z.utils.Success(this,this.$t("message.已成功上传方案"))},setAppCollectStyle(){r.Z["new"]().setAppField({app_id:this.getCurrAppId(),field_name:"collect_style",str_value:this.collectStyle}).then(function(e){e.data&&this.setApp(e.data)}.bind(this)).catch(function(e){c.Z.utils.Err(this,e)}.bind(this))}},computed:{...(0,o.Se)({getCurrAppId:"system/getCurrAppId"})}},f=v,w=(0,h.Z)(f,a,l,!1,null,"6c2aca80",null),S=w.exports},8993:function(e,t,s){s.d(t,{Z:function(){return r}});var a=s(90948),l=s(91803);class r{static new(){if(!(0,a.y7)())return new r}deleteEvent(e){return(0,l.Z)({url:"/api/saver/app/delete_event",method:"post",data:e})}deleteEventProp(e){return(0,l.Z)({url:"/api/saver/app/delete_event_prop",method:"post",data:e})}deleteUserProp(e){return(0,l.Z)({url:"/api/saver/app/delete_user_prop",method:"post",data:e})}uploadCustomProps(e){return(0,l.Z)({url:"/api/saver/app/upload_custom_props",method:"post",data:e})}GetDownloadCode(e){return(0,l.Z)({url:"/api/saver/app/get_download_code",method:"post",data:e})}}}}]);