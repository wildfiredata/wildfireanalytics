"use strict";(self["webpackChunkwildfire"]=self["webpackChunkwildfire"]||[]).push([[8558],{9689:function(t,e,i){i.r(e),i.d(e,{default:function(){return T}});var s=function(){var t=this,e=t._self._c;return e("div",{staticClass:"root"},[e("div",{staticClass:"containerClass"},[e("div",{staticClass:"top_toolbar h40"},[e("div",[t.name?e("EditLabel",{staticClass:"h40 ml10",attrs:{fontSize:"title"},model:{value:t.name,callback:function(e){t.name=e},expression:"name"}}):e("span",{staticClass:"title h40 ml10 nonuserselect"},[t._v(t._s(t.$t("message.漏斗分析")))])],1),e("div",{staticClass:"top_toolbar_erea"},[e("div",[e("span",{staticClass:"size12 nonuserselect"},[t._v(t._s(t.$t("message.选择分析主体")+":")+" ")]),e("el-select",{staticClass:"mr10 w120",attrs:{size:"mini",placeholder:t.$t("message.选择分析主体")},model:{value:t.EntityId,callback:function(e){t.EntityId=e},expression:"EntityId"}},t._l(t.EntityList,(function(t){return e("el-option",{key:t.value,attrs:{label:t.label,value:t.value}})})),1)],1),e("el-select",{staticClass:"mr10 w120",attrs:{size:"mini",placeholder:t.$t("message.请选择默认分析时区")},model:{value:t.zone,callback:function(e){t.zone=e},expression:"zone"}},t._l(t.zones,(function(t){return e("el-option",{key:t.value,attrs:{label:t.label,value:t.value}})})),1),e("div",{staticClass:"ml10 w100 h30"},[e("b-button",{attrs:{type:"is-primary",size:"is-small",expanded:""},on:{click:function(e){return t.on_click_save(t.id)}}},[t._v(t._s(t.$t("message.保存")))]),e("SaveAnalysis",{ref:"saveAnalysis",on:{sucess:t.on_save_success}})],1),t.id>0?e("div",{staticClass:"ml10 w100 h30"},[e("b-button",{attrs:{type:"is-primary",size:"is-small",expanded:""},on:{click:function(e){return t.on_click_save(0)}}},[t._v(t._s(t.$t("message.另存为")))])],1):t._e(),e("div",{staticClass:"ml10 w100 h30"},[e("b-button",{attrs:{type:"is-primary",size:"is-small",expanded:""},on:{click:t.on_click_analyze}},[t._v(t._s(t.$t("message.计算")))])],1)],1)]),e("splitpanes",{staticClass:"default-theme"},[e("pane",{attrs:{size:t.paneSize,"max-size":"60"}},[e("div",{staticClass:"left-root"},[e("div",{staticClass:"left-work-area onSliderScroll"},[e("div",{staticClass:"title_area nonuserselect"},[t._v(t._s(t.$t("message.漏斗步骤"))+" "),e("div",{staticClass:"title_area_button"},[e("b-switch",{attrs:{size:"is-small",rounded:!1,"left-label":!0},model:{value:t.switchLinkProp,callback:function(e){t.switchLinkProp=e},expression:"switchLinkProp"}},[t._v(t._s(t.$t("message.关联属性")+"："))]),e("div",{on:{click:t.reset}},[e("el-tooltip",{attrs:{effect:"light",placement:"top",content:t.$t("message.重置")}},[e("b-icon",{staticClass:"span_button",attrs:{"custom-size":"mdi-18px",size:"default",icon:"refresh"}})],1)],1),e("div",{on:{click:function(e){return t.addNewMetric(!1)}}},[e("el-tooltip",{attrs:{effect:"light",placement:"top",content:"添加漏斗步骤"}},[e("b-icon",{staticClass:"span_button",attrs:{"custom-size":"mdi-18px",size:"default",icon:"plus"}})],1)],1)],1)]),e("div",[e("draggable",t._b({staticClass:"list-group",attrs:{tag:"ul"},on:{start:t.startDrag,end:t.afterDrag},model:{value:t.metrics,callback:function(e){t.metrics=e},expression:"metrics"}},"draggable",t.dragOptions,!1),[e("transition-group",{attrs:{type:"transition"}},t._l(t.metrics,(function(i){return e("li",{key:i.id,staticClass:"list-group-item"},[e("div",{staticClass:"matricLabelClass"},[e("b-icon",{staticClass:"dragicon",attrs:{icon:"drag"}}),e("div",{staticClass:"avataricon"},[e("el-avatar",{staticClass:"elavatarclass",attrs:{size:18,shape:"square"}},[t._v(t._s(i.id))])],1),e("EditLabel",{staticClass:"EditLabelClass",on:{input:function(e){return t.on_input_label(i)}},model:{value:i.label,callback:function(e){t.$set(i,"label",e)},expression:"element.label"}})],1),i.isFormular?e("div",[e("el-input",{class:{inputFormularClass:!0,inputFormularWarnClass:i.formularError.length>0},attrs:{size:"mini"},on:{change:function(e){return t.on_change_formular(i)},input:function(e){return t.on_input_formular(i)}},model:{value:i.formular,callback:function(e){t.$set(i,"formular",e)},expression:"element.formular"}},[e("el-select",{staticClass:"formularModiferClass",attrs:{slot:"append",size:"mini"},slot:"append",model:{value:i.modifier,callback:function(e){t.$set(i,"modifier",e)},expression:"element.modifier"}},t._l(t.ModiferList,(function(t){return e("el-option",{key:t.value,attrs:{label:t.label,value:t.value}})})),1)],1),i.formularError.length>0?e("span",[e("el-tooltip",{attrs:{effect:"light",placement:"top",content:i.formularError}},[e("b-icon",{staticClass:"danger",attrs:{icon:"alert-circle",size:"is-small"}})],1)],1):t._e(),e("span",{on:{click:function(e){return t.deleteMetric(i.id)}}},[e("el-tooltip",{attrs:{effect:"light",placement:"top",content:t.$t("message.删除")}},[e("b-icon",{staticClass:"iconClass",attrs:{icon:"close-circle",size:"is-small"}})],1)],1)],1):e("div",[e("el-select",{staticClass:"mr10",attrs:{size:"mini",filterable:"","default-first-option":!0,placeholder:t.$t("message.请选择")},on:{change:function(e){return t.on_change_event(i)}},model:{value:i.event,callback:function(e){t.$set(i,"event",e)},expression:"element.event"}},t._l(t.EventList,(function(t){return e("el-option",{key:t.value,attrs:{label:t.label,value:t.value}})})),1),e("span",{on:{click:function(e){return t.addTopEventPropCondition(i.combo)}}},[e("el-tooltip",{attrs:{effect:"light",placement:"top",content:t.$t("message.添加筛选")}},[e("b-icon",{staticClass:"iconClass",attrs:{icon:"filter-plus-outline",size:"is-small"}})],1)],1),t.getBasicMetricCount()>2?e("span",{on:{click:function(e){return t.deleteMetric(i.id)}}},[e("el-tooltip",{attrs:{effect:"light",placement:"top",content:t.$t("message.删除")}},[e("b-icon",{staticClass:"iconClass",attrs:{icon:"close-circle",size:"is-small"}})],1)],1):t._e(),i.loadingOk?e("PropConditionGroup",{attrs:{eventProps:i.eventProps,keepLast:!1,userProps:[],userGroups:[],userTags:[]},model:{value:i.combo,callback:function(e){t.$set(i,"combo",e)},expression:"element.combo"}}):t._e(),t.switchLinkProp?e("div",{staticClass:"rowRightCenter mt2"},[e("span",{staticStyle:{"font-size":"12px"}},[t._v(t._s(t.$t("message.关联属性")+"："))]),e("SelectPicker",{attrs:{defaulted:!0,tabGroups:t.pickableEventProps(i),fontSize:t.fontSize},model:{value:i.link_prop_obj,callback:function(e){t.$set(i,"link_prop_obj",e)},expression:"element.link_prop_obj"}})],1):t._e()],1)])})),0)],1),e("div",{staticClass:"mt10 ml5 nonuserselect"},[t._v(t._s(this.$t("message.窗口期")+":"))]),e("b-dropdown",{staticClass:"bdropdownborder",attrs:{"append-to-body":"","trap-focus":"","aria-role":"dialog"},scopedSlots:t._u([{key:"trigger",fn:function(){return[e("span",{staticClass:"navbar-item",attrs:{role:"button"}},[e("span",{staticStyle:{"font-size":"12px"}},[t._v(t._s(t.RetentValueText))]),e("b-icon",{staticStyle:{margin:"5px"},attrs:{icon:"cog-outline",size:"is-small"}})],1)]},proxy:!0}])},[e("b-dropdown-item",{attrs:{focusable:!1,custom:"",paddingless:"","close-on-click":!1,"can-close":"outside"}},[e("div",{staticStyle:{width:"350px"}},[e("section",{staticClass:"modal-card-body"},[e("b-field",{attrs:{label:t.$t("message.窗口期")}},[e("div",{staticClass:"rowRightCenter"},[e("el-select",{staticClass:"w100ml10",attrs:{size:"small",placeholder:t.$t("message.请选择")},model:{value:t.FunnelSet.currentWindow,callback:function(e){t.$set(t.FunnelSet,"currentWindow",e)},expression:"FunnelSet.currentWindow"}},t._l(t.WindowList,(function(t){return e("el-option",{key:t.value,attrs:{label:t.label,value:t.value}})})),1),1==t.FunnelSet.currentWindow?e("div",{staticClass:"w100 ml10"},[e("el-input-number",{staticStyle:{width:"100px","margin-right":"5px"},attrs:{size:"small","controls-position":"right",min:1,max:999},on:{change:t.on_change_customwindownum},model:{value:t.FunnelSet.customWindowNum,callback:function(e){t.$set(t.FunnelSet,"customWindowNum",e)},expression:"FunnelSet.customWindowNum"}})],1):t._e(),1==t.FunnelSet.currentWindow?e("el-select",{staticClass:"w100 ml10",attrs:{size:"small",placeholder:t.$t("message.请选择")},model:{value:t.FunnelSet.customWindowUnit,callback:function(e){t.$set(t.FunnelSet,"customWindowUnit",e)},expression:"FunnelSet.customWindowUnit"}},[e("el-option",{attrs:{label:t.$t("message.天"),value:"day"}}),e("el-option",{attrs:{label:t.$t("message.小时"),value:"hour"}}),e("el-option",{attrs:{label:t.$t("message.分钟"),value:"minute"}})],1):t._e()],1)]),e("b-field",{attrs:{label:t.$t("message.查看")}},[e("el-radio-group",{model:{value:t.FunnelSet.convLost,callback:function(e){t.$set(t.FunnelSet,"convLost",e)},expression:"FunnelSet.convLost"}},[e("el-radio",{attrs:{label:!0}},[t._v(t._s(t.$t("message.转化")))]),e("el-radio",{attrs:{label:!1}},[t._v(t._s(t.$t("message.流失")))])],1)],1)],1)])])],1)],1),e("div",{staticClass:"title_area nonuserselect",on:{click:t.addGlobalFilter}},[t._v(t._s(t.$t("message.全局筛选"))+" "),e("div",{staticClass:"title_area_button"},[e("div",[e("el-tooltip",{attrs:{effect:"light",placement:"top",content:t.$t("message.添加全局筛选")}},[e("b-icon",{staticClass:"span_button",attrs:{"custom-size":"mdi-18px",size:"default",icon:"plus"}})],1)],1),e("b-icon",{staticClass:"span_button",attrs:{"custom-size":"mdi-18px",size:"default",icon:""}})],1)]),e("div",[e("PropConditionGroup",{attrs:{eventProps:t.MultiEventPropList,keepLast:!1,userProps:t.UserPropList,userGroups:t.UserGroupList,userTags:t.UserTagList},model:{value:t.GlobalFilter,callback:function(e){t.GlobalFilter=e},expression:"GlobalFilter"}})],1),e("div",{staticClass:"title_area nonuserselect",on:{click:t.addGroupby}},[t._v(t._s(t.$t("message.分组"))),e("div",{staticClass:"title_area_button"},[e("div",[e("el-tooltip",{attrs:{effect:"light",placement:"top",content:t.$t("message.添加分组")}},[e("b-icon",{staticClass:"span_button",attrs:{"custom-size":"mdi-18px",size:"default",icon:"plus"}})],1)],1),e("b-icon",{staticClass:"span_button",attrs:{"custom-size":"mdi-18px",size:"default",icon:""}})],1)]),e("div",[e("draggable",t._b({staticClass:"list-group",attrs:{tag:"ul"},on:{end:t.afterGroupbyDrag},model:{value:t.Groupbys.children,callback:function(e){t.$set(t.Groupbys,"children",e)},expression:"Groupbys.children"}},"draggable",t.dragOptions,!1),[e("transition-group",{attrs:{type:"transition"}},t._l(t.Groupbys.children,(function(i){return e("li",{key:i.id,staticClass:"list-group-item"},[e("div",{staticClass:"matricLabelClass"},[e("b-icon",{staticClass:"dragicon",attrs:{icon:"drag"}}),e("div",{staticClass:"groupyicon"},[e("el-avatar",{staticClass:"elavatarclass",attrs:{size:18,shape:"square"}},[t._v(t._s(i.id))])],1),e("GroupbyCondition",{attrs:{tabGroups:t.tabGroups},model:{value:i.groupbyfield,callback:function(e){t.$set(i,"groupbyfield",e)},expression:"element.groupbyfield"}}),e("span",{on:{click:function(e){return t.deleteGroupby(i.id)}}},[e("el-tooltip",{attrs:{effect:"light",placement:"top",content:t.$t("message.删除")}},[e("b-icon",{staticClass:"iconClass",attrs:{icon:"close-circle",size:"is-small"}})],1)],1)],1)])})),0)],1)],1)])])]),e("pane",{attrs:{size:100-t.paneSize}},[e("div",{staticClass:"chart_root"},[e("div",{staticClass:"chart_toolbar"},[e("div",{staticClass:"chart_toolbar_left"},[e("QuickDateTimeRangePicker",{ref:"quicktimepicker1",staticClass:"ml10",attrs:{fontSize:"mini"},on:{change:t.on_timerange_change},model:{value:t.analyzeTimeRange1,callback:function(e){t.analyzeTimeRange1=e},expression:"analyzeTimeRange1"}})],1),e("div",{staticClass:"chart_toolbar_right"},[e("el-cascader",{staticClass:"w130 ml10 mr10",attrs:{options:t.chartDataSpecList,size:"mini"},on:{change:t.switchChartType},model:{value:t.funnelDura,callback:function(e){t.funnelDura=e},expression:"funnelDura"}}),e("div",{class:{svgicon_button:!0,activeIcon:!t.hideTable},on:{click:function(e){t.hideTable=!t.hideTable}}},[e("el-tooltip",{staticClass:"item",attrs:{effect:"light",content:t.$t("message.表格"),placement:"bottom-end"}},[e("div",[e("inline-svg",{attrs:{width:"16",height:"16",src:i(69793)}})],1)])],1),t._l(t.availableChartList,(function(s){return e("div",{key:s.value,class:{svgicon_button:!0,activeIcon:!t.hideChart&&t.currentChart==s.value},on:{click:function(e){return t.switchChartType(s.value)}}},[e("el-tooltip",{staticClass:"item",attrs:{effect:"light",content:s.label,placement:"bottom-end"}},[e("div",[e("inline-svg",{attrs:{width:"16",height:"16",src:i(97773)("./"+s.icon+".svg")}})],1)])],1)}))],2)]),t.tableDataLoading?e("div",{directives:[{name:"loading",rawName:"v-loading",value:t.tableDataLoading,expression:"tableDataLoading"}],staticClass:"mh100"}):[t.hideChart?t._e():e("div",{staticClass:"chartDiv",attrs:{id:"chartViewContainer"}},[t.loadTableDataOnce?e("ChartView",{attrs:{option:t.chartOption,containerId:"chartViewContainer"}}):t._e()],1),t.loadTableDataOnce&&!t.hideTable?e("TablePlusSummaryCellEdit",{attrs:{loading:t.tableDataLoading,useCell:"percent",enableSummary:!0,enableTranspose:!1},model:{value:t.tableData,callback:function(e){t.tableData=e},expression:"tableData"}}):t._e()]],2)])],1)],1)])},a=[],n=(i(57658),i(83581)),r=i(74855),l=i(90309),o=i(43782),c=i(9808),u=i(36144),h=i(43436),p=i(76983),d=i.n(p),m=i(63822),b=i(95705),v=i(47056),g=i(794),f=i(62147),_=i(36797),y=i.n(_),C=i(19976),L=i(99877);const k=i(89405)._b;var w={components:{Splitpanes:n.F,Pane:n.X,ChartView:b.Z,SaveAnalysis:C.Z,draggable:d(),EditLabel:r.Z,SelectPicker:h.Z,InlineSvg:L.ZP,PropConditionGroup:l.Z,GroupbyCondition:o.Z,QuickDateTimeRangePicker:c.Z,TablePlusSummaryCellEdit:u.Z},created(){this.WindowList=[{label:this.$t("message.当天"),value:0,num:0,unit:""},{label:this.$t("message.自定义"),value:1,num:-1,unit:""},{label:"5 "+this.$t("message.分钟"),value:2,num:5,unit:"minute"},{label:"10 "+this.$t("message.分钟"),value:3,num:10,unit:"minute"},{label:"30 "+this.$t("message.分钟"),value:4,num:30,unit:"minute"},{label:"1 "+this.$t("message.小时"),value:5,num:1,unit:"hour"},{label:"5 "+this.$t("message.小时"),value:6,num:5,unit:"hour"},{label:"10 "+this.$t("message.小时"),value:7,num:10,unit:"hour"},{label:"24 "+this.$t("message.小时"),value:8,num:24,unit:"hour"},{label:"5 "+this.$t("message.天"),value:9,num:5,unit:"day"},{label:"7 "+this.$t("message.天"),value:10,num:7,unit:"day"}]},mounted(){this.initialize()},data:()=>({zones:[],EntityList:[],EventList:[],UserPropList:[],UserGroupList:[],UserTagList:[],ModiferList:[],WindowList:[],EventPropList:[],tabGroups:[],availableChartList:[],report_id:0,id:0,name:"",paneSize:45,zone:g.Z.def.TimeZone.Utcp8,EntityId:0,MultiEventPropList:[],GlobalFilter:{logicop:g.Z.def.LogicOp.LogicOpAnd,children:[]},Groupbys:{children:[]},FunnelSet:{convLost:!0,currentWindow:10,customWindowUnit:"day",customWindowNum:7},metrics:[],analyzeTimeRange1:{time_pick:!1,quick_range:"this_7day",start_unit:"day",end_unit:"day",start_offset:1,end_offset:0,start_dynamic:!0,end_dynamic:!0,start_time:"2023-06-28 00:00:00",end_time:"2023-06-29 23:59:59"},tableData:{},tableDataLoading:!1,loadTableDataOnce:!1,switchLinkProp:!1,funnelDura:[-1],chartDataSpecList:[],hideTable:!1,hideChart:!1,chartOption:{},tempLastPost:"",respData:{},currentChart:g.Z.def.ChartType.Line,chartDataSet:{},chartViewContainer:"",postSteps:[]}),methods:{initialize(){this.chartDataSpecList=[{value:-1,label:this.$t("message.全体")}],this.availableChartList=f.Z.analysisFunnel.GetChartTypeList(),this.currentChart=g.Z.def.ChartType.Line,this.loadZones(),this.ModiferList=g.Z.def.ModifierType.getLabelValueList();var t=this.getCurrAppId(),e=f.Z.api.LoadPlainEventList(t,!0),i=f.Z.api.LoadUserProp(t),s=f.Z.api.LoadUserClusterList(t),a=f.Z.api.LoadUserTagList(t,!0),n=f.Z.api.LoadAnalysisEnityList(t),r=Promise.all([i,e,s,a,n]);r.then((t=>{this.UserPropList=t[0],this.EventList=t[1],this.UserGroupList=t[2],this.UserTagList=t[3],this.EntityList=t[4],this.chooseSystemDefaultEntity(),this.UserGroupList.forEach((t=>{t.client_data=null,t.table_type=g.Z.def.TableType.TableTypeEvent})),this.UserTagList.forEach((t=>{t.client_data=null,t.table_type=g.Z.def.TableType.TableTypeEvent})),this.tabGroups=f.Z.filtersub.MakeTabGroup(null,this.UserPropList,this.UserGroupList,this.UserTagList);var e=this.$route.params;e&&(this.report_id=e.report_id),e&&!g.Z.utils.IsEmptyObj(e.client_data)?this.restoreClientData(e.client_data):(this.addNewMetric(!1),this.addNewMetric(!1))})).catch((t=>{g.Z.utils.Err(this,t)}))},chooseSystemDefaultEntity(){for(var t=0;t<this.EntityList.length;t++)if(this.EntityList[t].is_system)return this.EntityId=this.EntityList[t].id,void(this.EntityList[t].label=this.EntityList[t].label+this.$t("message.(默认)"))},restoreClientData(t){this.id=t.id,this.name=t.name,this.paneSize=t.paneSize,this.zone=t.zone,this.EntityId=t.EntityId,this.MultiEventPropList=t.MultiEventPropList,this.GlobalFilter=t.GlobalFilter,this.Groupbys=t.Groupbys,this.FunnelSet=t.FunnelSet,this.metrics=t.metrics,this.switchLinkProp=t.switchLinkProp,this.analyzeTimeRange1=t.analyzeTimeRange1,this.$refs.quicktimepicker1.setValue(t.analyzeTimeRange1);for(var e=0;e<this.metrics.length;e++)this.metrics[e].loadingOk=!1;for(e=0;e<this.metrics.length;e++)this.loadEventProp(this.metrics[e]);this.tableDataLoading=!0,this.respData=t.respData,this.postSteps=t.postSteps,this.hideTable=!1,this.hideChart=!1,setTimeout((()=>{this.switchChartType(this.currentChart,!0)}),100)},getEventLabel(t){for(var e=0;e<this.EventList.length;e++)if(this.EventList[e].value==t)return this.EventList[e].label;return""},startDrag(){},afterDrag(){this.rebindData().then((()=>{this.validateAllFormular()}))},on_change_customwindownum(){},loadZones(){this.zones.push({label:g.Z.def.TimeZone.getZhLabel(g.Z.def.TimeZone.Utcp8),value:g.Z.def.TimeZone.Utcp8});var t=-12;while(t<13)8!==t&&this.zones.push({label:g.Z.def.TimeZone.getZhLabel(t),value:t}),t+=1},rebindData(){return new Promise(function(t){this.refreshMetricId();var e=g.Z.utils.DeepClone(this.metrics);setTimeout((()=>{this.metrics=e,t("ok")}),10)}.bind(this))},refreshMetricId(){for(var t=0;t<this.metrics.length;t++)this.metrics[t].id=t<26?String.fromCharCode(65+t):"A"+String.fromCharCode(65+t-26)},addTopEventPropCondition(t){g.Z.condx.GroupAdd(t,0,1,{selectedOp:"=",record:{}})},deleteMetric(t){for(var e=0;e<this.metrics.length;e++)if(this.metrics[e].id==t)return this.metrics.splice(e,1),void this.rebindData().then((()=>{this.refreshCommEventProp(),this.deleteDangleGlobalFilterCondition(),this.deleteDangleGroupbyCondition()}))},getBasicMetricIdList(){for(var t=[],e=0;e<this.metrics.length;e++)this.metrics[e].isFormular||t.push(this.metrics[e].id);return t},getBasicMetricCount(){for(var t=0,e=0;e<this.metrics.length;e++)this.metrics[e].isFormular||t++;return t},getNewFormularName(){for(var t=1,e=0;e<this.metrics.length;e++)this.metrics[e].isFormular&&t++;return this.$t("message.自定义公式")+String(t)},setFormularError(t){t.formularError=this.$t("message.公式有误, 请仔细检查表达式")},reset(){this.metrics.length>1&&(this.metrics=[this.metrics[0],this.metrics[1]]),this.GlobalFilter={logicop:g.Z.def.LogicOp.LogicOpAnd,children:[]},this.Groupbys={children:[]},this.rebindData().then()},addNewMetric(){if(!(this.metrics.length>=g.Z.def.Limit.LimitAnalysisEventMaxMetrics)){var t={label:"",id:"A",event:"",metric:"",modifier:g.Z.def.ModifierType.ModifierTypeNone,loadingOk:!1,labelchanged:!1,eventProps:[],combo:{logicop:g.Z.def.LogicOp.LogicOpAnd,children:[]}};this.EventList.length>0&&(t.event=this.EventList[0].value,this.loadEventProp(t)),this.metrics.push(t),this.refreshMetricId(),this.updateStepLabel()}},on_input_label(t){t.labelchanged=!0},updateStepLabel(){for(var t=0;t<this.metrics.length;t++)this.metrics[t].labelchanged||(this.metrics[t].label=this.getEventLabel(this.metrics[t].event))},on_change_event(t){this.loadEventProp(t),this.updateStepLabel()},addGlobalFilter(){g.Z.condx.GroupAdd(this.GlobalFilter,0,1,{selectedOp:"=",record:{}})},updateChartDataSpecList(t){this.chartDataSpecList=[],this.chartDataSpecList.push({value:-1,label:this.$t("message.全体")}),t.forEach(((e,i)=>{if(i<t.length-1){var s={value:i,label:this.$t("message.步骤")+e.id,children:[]};t.forEach(((t,e)=>{e>i&&s.children.push({value:e,label:this.$t("message.步骤")+t.id})})),this.chartDataSpecList.push(s)}}))},pickableEventProps(t){var e=[],i={group_name:this.$t("message.事件属性"),value:this.$t("message.事件属性"),type:"list",icon:"",children:[]};i.children=t.eventProps.filter((t=>!g.Z.def.PropDelimiter.isRelateObjectField(t.type_prop_name)&&g.Z.def.DataType.isPrimaryType(t.type)));for(var s=0;s<i.children.length;s++)i.children[s].label2=g.Z.def.PropertyType.getZhLabel(i.children[s].label2),i.children[s].label3=g.Z.def.DataType.getZhLabel(i.children[s].type);return i.children&&i.children.length>0&&e.push(i),e},deleteDangleGlobalFilterCondition(){for(var t=g.Z.condx.Clone2List(this.GlobalFilter),e=0;e<t.length;e++){for(var i=!1,s=0;s<this.MultiEventPropList.length;s++)if(this.MultiEventPropList[s].table_type==g.Z.def.TableType.TableTypeEvent&&this.MultiEventPropList[s].type_prop_name==t[e].record.pickersubject.type_prop_name){i=!0;break}i||g.Z.condx.GroupRemove(this.GlobalFilter,t[e].id)}},deleteDangleGroupbyCondition(){for(var t=g.Z.utils.DeepClone(this.Groupbys.children),e=0;e<t.length;e++){for(var i=!1,s=0;s<this.MultiEventPropList.length;s++)if(this.MultiEventPropList[s].table_type==g.Z.def.TableType.TableTypeEvent&&this.MultiEventPropList[s].type_prop_name==t[e].groupbyfield.editing_field.type_prop_name){i=!0;break}i||g.Z.condx.GroupRemove(this.Groupbys,t[e].id)}},refreshCommEventProp(){for(var t=[],e=new Map,i=0;i<this.metrics.length;i++)if(this.metrics[i].eventProps)for(var s=0;s<this.metrics[i].eventProps.length;s++)if(!e.has(this.metrics[i].eventProps[s].type_prop_name)){e.set(this.metrics[i].eventProps[s].type_prop_name);var a=g.Z.utils.DeepClone(this.metrics[i].eventProps[s]);a.id=t.length,t.push(a)}return this.MultiEventPropList=t,this.tabGroups=[],setTimeout((()=>{this.tabGroups=f.Z.filtersub.MakeTabGroup(this.MultiEventPropList,this.UserPropList,this.UserGroupList,this.UserTagList)}),10),t},loadEventProp(t){for(var e=this.getCurrAppId(),i=0;i<this.metrics.length;i++)if(this.metrics[i]!==t&&this.metrics[i].event==t.event&&this.metrics[i].loadingOk)return t.eventProps=g.Z.utils.DeepClone(this.metrics[i].eventProps),void(t.loadingOk=!0);f.Z.api.LoadEventPropParamPromise({app_id:e,include_obj_schema:!0,include_dim_schema:!0,include_obj_dim_schema:!0,limit_event_name:[t.event]}).then((e=>{t.eventProps=e,this.refreshCommEventProp(),this.deleteDangleGlobalFilterCondition(),this.deleteDangleGroupbyCondition(),t.loadingOk=!0}))},on_input_formular(t){if(t&&t.formular){t.formular=t.formular.toUpperCase();for(var e="",i=0;i<t.formular.length;i++)g.Z.def.MathExpressChars.getList().indexOf(t.formular[i])>=0&&(e+=t.formular[i]);t.formular=e}},on_change_formular(t){this.validateFormular(t)},validateAllFormular(){for(var t=0;t<this.metrics.length;t++)this.metrics[t].isFormular&&this.validateFormular(this.metrics[t])},validateFormular(t){var e=new k;t.formularError="";try{var i=e.parse(t.formular);if(0==i.tokens.length)return void this.setFormularError(t,this.$t("message.公式不能为空"));for(var s=this.getBasicMetricIdList(),a=0;a<i.tokens.length;a++){if("IVAR"!=i.tokens[a].type&&"INUMBER"!=i.tokens[a].type&&"IOP2"!=i.tokens[a].type)return void this.setFormularError(t);if("IVAR"==i.tokens[a].type&&s.indexOf(i.tokens[a].value)<0)return void this.setFormularError(t,i.tokens[a].value)}}catch{this.setFormularError(t)}},addGroupby(){g.Z.condx.GroupAdd(this.Groupbys,0,1,{})},deleteGroupby(t){g.Z.condx.GroupRemove(this.Groupbys,t)},afterGroupbyDrag(){for(var t=g.Z.utils.DeepClone(this.Groupbys),e=0;e<t.children.length;e++)t.children[e].id=e+1;this.Groupbys.children=[],setTimeout((()=>{this.Groupbys=t}),10)},on_timerange_change(t){g.Z.utils.Ignore(t)},on_click_save(t){var e={},i=this.prepare_postdata(e);if(i)g.Z.utils.Err(this,i);else{var s={paneSize:this.paneSize,zone:this.zone,EntityId:this.EntityId,MultiEventPropList:this.MultiEventPropList,GlobalFilter:this.GlobalFilter,Groupbys:this.Groupbys,FunnelSet:this.FunnelSet,metrics:this.metrics,switchLinkProp:this.switchLinkProp,analyzeTimeRange1:this.analyzeTimeRange1,currentChart:this.currentChart,postSteps:this.postSteps},a=JSON.stringify(e);this.tempLastPost!=a?this.QueryApi().then((()=>{this.$refs.saveAnalysis.showDialog(t,this.name,s,e,this.respData,g.Z.def.AnalysisType.AnalysisTypeFunnel,0,this.report_id),this.tableDataLoading=!1})).catch(function(t){g.Z.utils.Err(this,t),this.tableDataLoading=!1}.bind(this)):(this.$refs.saveAnalysis.showDialog(t,this.name,s,e,this.respData,g.Z.def.AnalysisType.AnalysisTypeFunnel,0,this.report_id),this.tableDataLoading=!1)}},on_save_success(t){this.name=t.name,this.id=t.id},prepare_postdata(t){t.app=this.getCurrAppId(),t.enity_id=this.EntityId,t.time_zone=this.zone,t.steps=[],t.comm_filter=f.Z.metric.VuePropFilterGroup2ApiGlobalFilter(this.GlobalFilter),t.breaks=f.Z.breaks.VueGroupbys2ApiBreakList(this.metrics[0].event,this.Groupbys),t.analysis_time_range={time_zone:this.zone,range1:this.analyzeTimeRange1},t.funnel_set={conv_lost:this.FunnelSet.convLost,current_window:this.FunnelSet.currentWindow,custom_window_unit:this.FunnelSet.customWindowUnit,custom_window_num:this.FunnelSet.customWindowNum},t.funnel_dura=this.funnelDura,0==this.FunnelSet.currentWindow?(t.funnel_set.custom_window_unit=g.Z.def.TimeGrain.GrainSecond,t.funnel_set.custom_window_num=y()().unix()-y()(y()().utcOffset(this.zone).format("YYYY-MM-DD")).unix()):1!=this.FunnelSet.currentWindow&&(t.funnel_set.custom_window_unit=this.WindowList[this.FunnelSet.currentWindow].unit,t.funnel_set.custom_window_num=this.WindowList[this.FunnelSet.currentWindow].num);for(var e=0;e<this.metrics.length;e++)if(t.steps.push({id:this.metrics[e].id,label:this.metrics[e].label,filter:f.Z.metric.VueEventFilterGroup2ApiEventFilter(this.metrics[e].event,this.metrics[e].combo),link_type_prop_name:this.switchLinkProp?this.metrics[e].link_prop_obj.type_prop_name:""}),e>0&&this.switchLinkProp&&this.metrics[e].link_prop_obj.type!=this.metrics[e-1].link_prop_obj.type)return this.$t("message.错误：关联属性类型不一致错误，要求所有关联属性数据类型一致")},QueryApi(){var t={},e=this.prepare_postdata(t);return e?Promise.reject(e):(this.tableDataLoading=!0,this.tableData={},this.tempLastPost=JSON.stringify(t),v.Z["new"]().analyzeFunnel(t).then(function(e){return g.Z.utils.Ignore(e),this.respData=e.data,this.postSteps=t.steps,this.switchChartType(this.currentChart,!0),this.tableDataLoading=!1,this.loadTableDataOnce=!0,!0}.bind(this)))},on_click_analyze(){this.QueryApi().catch(function(t){g.Z.utils.Err(this,t),this.tableDataLoading=!1}.bind(this))},switchChartType(t,e){if(t==this.currentChart&&(this.hideChart=!this.hideChart),this.currentChart=t,e&&(this.hideChart=!1),!this.hideChart){if(this.tableDataLoading=!0,this.updateChartDataSpecList(this.postSteps),this.tableData=f.Z.analysisFunnel.ToTabledata(this.respData),this.currentChart==g.Z.def.ChartType.Line){this.chartDataSet=f.Z.analysisFunnel.ToMixchartDatasetByDate(this.respData);var i={unitY:"%"};this.chartOption=f.Z.BuidChart(this.currentChart,g.Z.utils.DeepClone(this.chartDataSet),i)}else this.chartDataSet=f.Z.analysisFunnel.ToMixchartDatasetWithoutDate(this.respData),this.chartOption=f.Z.BuidChart(this.currentChart,g.Z.utils.DeepClone(this.chartDataSet));this.tableDataLoading=!1,this.loadTableDataOnce=!0}}},computed:{...(0,m.Se)({getCurrAppId:"system/getCurrAppId"}),dragOptions(){return{animation:0,group:"description",disabled:!1,ghostClass:"ghost"}},RetentValueText:function(){var t="";return 1==this.FunnelSet.currentWindow?t=t+`${this.FunnelSet.customWindowNum}`+g.Z.def.TimeGrain.getZhLabel(this.FunnelSet.customWindowUnit):t+=this.WindowList[this.FunnelSet.currentWindow].label,this.FunnelSet.convLost?t+" "+this.$t("message.转化"):t+" "+this.$t("message.流失")}}},D=w,E=i(1001),S=(0,E.Z)(D,s,a,!1,null,"29323662",null),T=S.exports}}]);