"use strict";(self["webpackChunkwildfire"]=self["webpackChunkwildfire"]||[]).push([[7564],{7564:function(s,t,e){e.r(t),e.d(t,{default:function(){return _}});var i=function(){var s=this,t=s._self._c;return t("div",{staticClass:"root"},[t("div",{staticClass:"workerea"},[t("div",[t("div",{staticClass:"filter_work_erea"},[t("div",[t("span",{staticClass:"nonuserselect mr12"},[s._v(s._s(s.$t("message.显示名称"))+"：")]),s._v(" "),t("el-input",{class:{ml10:!0,w300:!0,mr20:!0,borderdanger:s.EmptyNameErr},attrs:{size:"small"},model:{value:s.Name,callback:function(t){s.Name=t},expression:"Name"}})],1),t("div",{staticClass:"mt10"},[t("span",{staticClass:"nonuserselect mr12"},[s._v(s._s(s.$t("message.更新方式"))+"：")]),t("el-switch",{attrs:{"active-value":"daily","inactive-value":"manual","active-text":s.$t("message.自动"),"inactive-text":s.$t("message.手动")},model:{value:s.RefreshMode,callback:function(t){s.RefreshMode=t},expression:"RefreshMode"}})],1),s._l(s.filters,(function(e,i){return t("div",{key:i,staticClass:"mt10"},[t("span",[s._v(" "+s._s(0==i?s.$t("message.选择主分析:"):s.$t("message.选择从分析:"))+" "),t("el-select",{class:{ml10:!0,w300:!0,mr20:!0,borderdanger:e.taberr},attrs:{size:"small",placeholder:s.$t("message.请选择")},on:{change:function(t){return s.on_change_linktable(i)}},model:{value:e.analysis_id,callback:function(t){s.$set(e,"analysis_id",t)},expression:"filter.analysis_id"}},s._l(s.analysisList,(function(e){return t("el-option",{key:e.id,attrs:{label:e.idname,value:e.id}},[t("span",{staticStyle:{float:"left"}},[s._v(s._s(e.idname))]),t("span",{staticStyle:{float:"right",color:"#8492a6","font-size":"13px"}},[s._v(s._s(s.pub.def.AnalysisType.getZhLabel(e.analysis_type)))])])})),1)],1),t("span",[s._v(s._s(s.$t("message.选择可见列"))+": "),t("el-select",{class:{ml10:!0,w200:!0,mr20:!0,borderdanger:e.colerr},staticStyle:{"margin-left":"20px"},attrs:{size:"small",multiple:"","collapse-tags":"",placeholder:s.$t("message.请选择")},model:{value:e.columns,callback:function(t){s.$set(e,"columns",t)},expression:"filter.columns"}},s._l(s.getColumnsByAnalysisId(e.analysis_id),(function(s){return t("el-option",{key:s.field,attrs:{label:s.label,value:s.field}})})),1)],1),s.filters.length>1?t("span",[s._v(s._s(s.$t("message.选择关联字段"))+": "),t("el-select",{class:{ml10:!0,w200:!0,mr20:!0,borderdanger:e.joinerr},staticStyle:{"margin-left":"20px"},attrs:{size:"small","collapse-tags":"",placeholder:s.$t("message.请选择")},model:{value:e.joinfield,callback:function(t){s.$set(e,"joinfield",t)},expression:"filter.joinfield"}},s._l(s.getColumnsByAnalysisId(e.analysis_id),(function(s){return t("el-option",{key:s.field,attrs:{label:s.label,value:s.field}})})),1)],1):s._e(),i>0?t("span",{on:{click:function(t){return s.deletefilter(i)}}},[t("el-tooltip",{staticClass:"cursorpointer",attrs:{effect:"dark",content:s.$t("message.删除"),placement:"top"}},[t("i",{staticClass:"el-icon-delete"})])],1):s._e(),0==i?t("span",{on:{click:s.on_click_addfilter}},[t("el-tooltip",{staticClass:"cursorpointer",attrs:{effect:"dark",content:s.$t("message.添加从分析"),placement:"top"}},[t("i",{staticClass:"el-icon-plus"})])],1):s._e()])}))],2),t("div",{staticClass:"buttons"},[t("el-button",{staticClass:"w90",attrs:{type:"primary",size:"mini"},on:{click:s.apply_join}},[s._v(s._s(s.$t("message.连接")))]),t("el-button",{staticClass:"w90",attrs:{type:"primary",size:"mini"},on:{click:s.MergedAnalysisUpdate}},[s._v(s._s(s.$t("message.保存")))])],1),t("div",{staticClass:"containerClass"},[t("div",{staticClass:"leftContainer"},[s.JoinTable.columns.length>0?t("draggable",s._b({staticClass:"list-group",attrs:{tag:"ul"},model:{value:s.JoinTable.columns,callback:function(t){s.$set(s.JoinTable,"columns",t)},expression:"JoinTable.columns"}},"draggable",s.dragOptions,!1),[t("transition-group",{attrs:{type:"transition"}},s._l(s.JoinTable.columns,(function(e){return t("b-collapse",{key:e.id,attrs:{open:e.open,"aria-id":"contentIdForA11y1"},scopedSlots:s._u([{key:"trigger",fn:function(i){return[t("div",{staticClass:"titlerea",attrs:{role:"button"}},[t("span",{staticClass:"leftcenter titlename overflowellipsis"},[t("b-icon",{staticClass:"dragicon",attrs:{icon:"drag"}}),s._v(" "+s._s(e.title)+" ")],1),t("span",{staticClass:"leftcenter"},[t("span",{on:{click:function(t){return t.stopPropagation(),s.change_visible(e.id)}}},[e.visible?t("b-icon",{staticClass:"dragicon",attrs:{size:"is-small",icon:"eye-outline"}}):t("b-icon",{staticClass:"dragicon",attrs:{size:"is-small",icon:"eye-off-outline"}})],1),t("b-icon",{staticClass:"card-header-icon",attrs:{icon:i.open?"menu-down":"menu-up"}})],1)])]}}],null,!0)},[t("div",{staticClass:"notification"},[t("div",{staticClass:"pad5"},[t("span",{staticClass:"mr5"},[s._v(s._s(s.$t("message.标题"))+":")]),t("el-input",{staticClass:"w200",attrs:{size:"small"},model:{value:e.label,callback:function(t){s.$set(e,"label",t)},expression:"col.label"}}),t("el-radio-group",{staticClass:"ml10",attrs:{size:"mini"},model:{value:e.align,callback:function(t){s.$set(e,"align",t)},expression:"col.align"}},[t("el-radio-button",{attrs:{label:"left"}},[t("b-icon",{attrs:{icon:"format-align-left",size:"is-small"}})],1),t("el-radio-button",{attrs:{label:"center"}},[t("b-icon",{attrs:{icon:"format-align-center",size:"is-small"}})],1),t("el-radio-button",{attrs:{label:"right"}},[t("b-icon",{attrs:{icon:"format-align-right",size:"is-small"}})],1)],1)],1),t("div",{staticClass:"pad5"},[t("span",{staticClass:"mr5"},[s._v(s._s(s.$t("message.展示为"))+":")]),t("el-select",{attrs:{size:"small","collapse-tags":"",placeholder:s.$t("message.请选择")},model:{value:e.display_type,callback:function(t){s.$set(e,"display_type",t)},expression:"col.display_type"}},s._l(s.DisplayTypeList,(function(s){return t("el-option",{key:s.value,attrs:{label:s.label,value:s.value}})})),1)],1),s.enable_display_format(e.display_type)?t("div",{staticClass:"pad5"},[t("span",{staticClass:"mr5"},[s._v(s._s(s.enable_display_format(e.display_type))+s._s(s.$t("message.格式"))+" "),"number"==e.display_type?t("el-link",{attrs:{underline:!1,href:"https://numbrojs.com/old-format.html",target:"_blank"}},[t("i",{staticClass:"el-icon-question formatlink"})]):s._e(),"datetime"==e.display_type?t("el-link",{attrs:{underline:!1,href:"https://momentjs.com/docs/#/displaying",target:"_blank"}},[t("i",{staticClass:"el-icon-question formatlink"})]):s._e(),s._v(" : ")],1),t("el-input",{staticClass:"w300",attrs:{size:"small"},on:{input:s.rebindData,change:s.rebindData},model:{value:e.modifier,callback:function(t){s.$set(e,"modifier",t)},expression:"col.modifier"}})],1):s._e()])])})),1)],1):s._e()],1),t("div",[s.rebinding?s._e():t("TablePlusSummaryCellEdit",{attrs:{tableData:s.JoinTable}})],1)])])])])},a=[],l=(e(57658),e(76983)),n=e.n(l),r=e(47056),o=e(36144),d=e(794),c=e(62147),f=e(63822);const h="-";var m={components:{TablePlusSummaryCellEdit:o.Z,draggable:n()},props:{modeldata:{type:Object}},data(){return{DisplayTypeList:[],RefreshMode:d.Z.def.RefreshMode.RefreshModeManual,analysisList:[],analysisIdQueryAnalysis:{},filters:[{analysis_id:"",columns:[],desc:[],joinfield:"",taberr:!1,colerr:!1,joinerr:!1}],paneSize:45,Name:"",MergedId:0,EmptyNameErr:!1,JoinTable:{columns:[],data:[]},ListOfSubtable:[],rebinding:!1}},mounted(){this.initialize()},methods:{...(0,f.nv)({setApp:"system/setApp"}),initialize(){this.DisplayTypeList=d.Z.def.DisplayType.getLabelValueList(),r.Z["new"]().analysisListList({app_id:this.getCurrAppId()}).then(function(s){if(this.analysisList=[],s.data.list.length>0){var t=[];s.data.list.forEach((s=>{var e=d.Z.utils.ParseJsonObjectSafe(s.post_resp_data);d.Z.utils.IsEmptyObj(e)&&(s.refresh_err=this.$t("message.发现子分析数据缺失")),s.refresh_err||(s._tabledata=c.Z.QueryTableData(s.analysis_type,e),s.idname=`${s.id}.${s.name}`,this.analysisIdQueryAnalysis[s.id]=s,s.analysis_type!=d.Z.def.AnalysisType.AnalysisTypePath&&t.push(s))})),this.analysisList=t}this.modeldata&&this.modeldata.id&&!d.Z.utils.IsEmptyStr(this.modeldata.id)?(this.MergedId=this.modeldata.id,this.Name=this.modeldata.name,this.RefreshMode=this.modeldata.refresh_mode,this.filters=this.modeldata.filters,this.refresh_filter_title(),this.merge_join_table_columns(),this.join_table_data()):(this.Name="",this.MergedId=0,this.RefreshMode=d.Z.def.RefreshMode.RefreshModeManual)}.bind(this)).catch((s=>{d.Z.utils.Err(this,s)}))},getColumnsByAnalysisId(s){for(var t=0;t<this.analysisList.length;t++)if(this.analysisList[t].id==s){var e=this.analysisList[t]._tabledata.columns;return e}return[]},on_click_addfilter(){this.filters.push({analysis_id:"",columns:[],desc:[],joinfield:"",taberr:!1,colerr:!1,joinerr:!1})},deletefilter(s){this.filters.splice(s,1)},change_visible(s){this.JoinTable.columns.forEach((t=>{t.id==s&&(t.visible=!t.visible)}))},on_change_linktable(s){for(var t=this.filters[s].analysis_id,e=0;e<this.filters.length;e++)if(e!=s&&this.filters[e].analysis_id==t){d.Z.utils.Err(this,this.$t("message.不能重复关联分析表！")),this.filters[s].analysis_id="";break}this.filters[s].columns=[],this.filters[s].joinfield=""},enable_display_format(s){return s==d.Z.def.DisplayType.DisplayTypeNumber||s==d.Z.def.DisplayType.DisplayTypeDatetime?d.Z.def.DisplayType.getZhLabel(s):""},rebindData(){this.rebinding=!0,setTimeout((()=>{this.rebinding=!1}),100)},checkFilter(){if(this.EmptyNameErr=!1,d.Z.utils.IsEmptyStr(this.Name))return this.EmptyNameErr=!0,!1;for(var s=0;s<this.filters.length;s++){if(this.filters[s].taberr=!1,this.filters[s].colerr=!1,this.filters[s].joinerr=!1,d.Z.utils.IsEmptyStr(this.filters[s].analysis_id))return this.filters[s].taberr=!0,!1;if(0==this.filters[s].columns.length)return this.filters[s].colerr=!0,!1;if(this.filters.length>1&&d.Z.utils.IsEmptyStr(this.filters[s].joinfield))return this.filters[s].joinerr=!0,!1}return!0},refresh_filter_title(){for(var s=0;s<this.filters.length;s++)for(var t=0;t<this.filters[s].desc.length;t++){var e=this.filters[s].desc[t],i=this.analysisIdQueryAnalysis[e.analysis_id];d.Z.utils.IsEmptyObj(i)?d.Z.utils.Err(this,this.$t("message.发现子分析数据缺失")):(e.analysis_name=this.analysisIdQueryAnalysis[e.analysis_id].name,e.title=`${e.label}(${e.analysis_id}.${e.analysis_name})`)}},make_merge_column_desc(){for(var s=0;s<this.filters.length;s++){this.filters[s].desc=[];for(var t=0;t<this.filters[s].columns.length;t++){var e=this.analysisIdQueryAnalysis[this.filters[s].analysis_id];if(d.Z.utils.IsEmptyObj(e))d.Z.utils.Err(this,this.$t("message.发现子分析数据缺失"));else{var i=this.analysisIdQueryAnalysis[this.filters[s].analysis_id]._tabledata,a={analysis_id:this.filters[s].analysis_id,analysis_name:"",id:"",field:"",label:"",sort_type:"",visible:!0,align:"right"};a.analysis_name=this.analysisIdQueryAnalysis[this.filters[s].analysis_id].name,i.columns.forEach((e=>{e.field==this.filters[s].columns[t]&&(a.label=e.label,a.sort_type=e.sort_type,e.display_type?a.display_type=e.display_type:a.display_type=d.Z.def.DisplayType.fromSortType(e.sort_type),a.modifier=e.modifier,a.analysis_column_field=this.filters[s].columns[t])})),a.id=`${a.analysis_id}.${a.analysis_column_field}`,a.field=`${a.analysis_id}.${a.analysis_column_field}`,a.title=`${a.label}(${a.analysis_id}.${a.analysis_name})`,this.filters[s].desc.push(a)}}}},merge_join_table_columns(){var s=[];this.filters.forEach((t=>{s=s.concat(t.desc)})),this.JoinTable.columns=s},join_table_data(){this.JoinTable.data=[];var s=this.analysisIdQueryAnalysis[this.filters[0].analysis_id]._tabledata;s.data.forEach((s=>{for(var t={},e=0;e<this.filters[0].columns.length;e++)t[`${this.filters[0].analysis_id}.${this.filters[0].columns[e]}`]=s[this.filters[0].columns[e]];d.Z.utils.IsEmptyStr(this.filters[0].joinfield)||(t[h]=d.Z.utils.ParseStrSafe(s[this.filters[0].joinfield])),this.JoinTable.data.push(t),d.Z.utils.SortObjArrayByField(this.JoinTable.data,h,d.Z.def.BreakSortType.BreakSortTypeString)}));for(var t=[],e=1;e<this.filters.length;e++){var i=this.analysisIdQueryAnalysis[this.filters[e].analysis_id]._tabledata,a={analysis_id:this.filters[e].analysis_id,data:[]};i.data.forEach((s=>{for(var t={},i=0;i<this.filters[e].columns.length;i++)t[`${this.filters[e].analysis_id}.${this.filters[e].columns[i]}`]=s[this.filters[e].columns[i]];d.Z.utils.IsEmptyStr(this.filters[e].joinfield)||(t[h]=d.Z.utils.ParseStrSafe(s[this.filters[e].joinfield])),a.data.push(t)})),d.Z.utils.SortObjArrayByField(a.data,h,d.Z.def.BreakSortType.BreakSortTypeString),t.push(a)}for(this.ListOfSubtable=t,e=0;e<t.length;e++)if(0!=t[e].data.length){for(var l=[],n=0;n<this.JoinTable.data.length;n++){for(var r=this.JoinTable.data[n],o=!1,c=0;c<t[e].data.length;c++){var f=t[e].data[c];if(r[h]==f[h]){let s={...r,...f};l.push(s),o=!0}else if(1==o)break}o||l.push(r)}this.JoinTable.data=l}},apply_join(){this.checkFilter()&&(this.make_merge_column_desc(),this.merge_join_table_columns(),this.join_table_data()),this.rebindData()},MergedAnalysisUpdate(){if(this.checkFilter()){this.tableData=[];var s=this.getCurrAppId();r.Z["new"]().MergedAnalysisUpdate({app:s,id:this.MergedId,name:this.Name,filters:this.filters,refresh_mode:this.RefreshMode}).then(function(s){for(var t={id:s.data.id,name:this.Name,filters:this.filters,analysis_name_list:""},e=0;e<this.filters.length;e++)0!=e&&(t.analysis_name_list=t.analysis_name_list+","),t.analysis_name_list=t.analysis_name_list+this.analysisIdQueryAnalysis[this.filters[e].analysis_id].name;this.$emit("change",t),d.Z.utils.Success(this,this.$t("message.保存成功"))}.bind(this)).catch(function(s){d.Z.utils.Err(this,s)}.bind(this))}}},computed:{...(0,f.Se)({getCurrAppId:"system/getCurrAppId"}),dragOptions(){return{animation:0,group:"description",disabled:!1,ghostClass:"ghost"}}}},u=m,y=e(1001),p=(0,y.Z)(u,i,a,!1,null,"36d02d39",null),_=p.exports}}]);