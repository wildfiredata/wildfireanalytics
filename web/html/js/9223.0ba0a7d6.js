"use strict";(self["webpackChunkwildfire"]=self["webpackChunkwildfire"]||[]).push([[9223],{29223:function(e,t,a){a.r(t),a.d(t,{default:function(){return g}});var i=function(){var e=this,t=e._self._c;return t("div",{staticClass:"root"},[t("div",{staticClass:"title"},[e._v(e._s(e.$t("message.维度表")))]),t("div",{staticClass:"toolbar"},[t("el-button",{staticClass:"toolbaritem",attrs:{size:"small"},on:{click:e.displayNewDialog}},[e._v(e._s(e.$t("message.添加维度表")))])],1),t("el-table",{staticStyle:{width:"100%"},attrs:{data:e.tableData,"row-key":"id","min-height":"250",border:"","default-expand-all":"","tree-props":{children:"children"}}},[t("el-table-column",{attrs:{sortable:"",prop:"dim_name",label:e.propColsVisible["dim_name"].title}}),t("el-table-column",{attrs:{sortable:"",prop:"link_prop",label:e.propColsVisible["link_prop"].title},scopedSlots:e._u([{key:"default",fn:function({row:a}){return e._l(a.link_prop,(function(a,i){return t("div",{key:i,staticClass:"propdesc"},[t("b-icon",{attrs:{icon:a.icon,size:"is-small"}}),t("span",[e._v(e._s(a.name))])],1)}))}}])}),t("el-table-column",{attrs:{sortable:"",prop:"label",label:e.propColsVisible["label"].title}}),t("el-table-column",{attrs:{sortable:"",prop:"memo",label:e.propColsVisible["memo"].title}}),t("el-table-column",{attrs:{sortable:"",prop:"update_time",label:e.propColsVisible["update_time"].title}}),t("el-table-column",{attrs:{label:e.$t("message.操作")},scopedSlots:e._u([{key:"default",fn:function({row:a}){return[t("div",[t("el-button",{attrs:{type:"text",size:"small"},nativeOn:{click:function(t){return t.preventDefault(),e.displayEditDialog(a)}}},[e._v(e._s(e.$t("message.显示详情")))]),t("el-button",{attrs:{type:"text",size:"small",disabled:a.link_prop&&a.link_prop.length>0},nativeOn:{click:function(t){return t.preventDefault(),e.deleteDimTable(a)}}},[e._v(e._s(e.$t("message.删除")))])],1)]}}])})],1),t("el-dialog",{attrs:{title:e.dialogTitle,"append-to-body":!0,"close-on-click-modal":!1,visible:e.dialogVisible,width:"700px",top:"7vh"},on:{"update:visible":function(t){e.dialogVisible=t}}},[t("el-form",{ref:"formName",staticClass:"ruleFormClass",attrs:{model:e.formData,rules:e.rules,"label-width":"120px"}},[t("el-form-item",{attrs:{label:e.$t("message.维度表显示名称"),prop:"label"}},[t("el-input",{on:{input:e.on_change_name},model:{value:e.formData.label,callback:function(t){e.$set(e.formData,"label",t)},expression:"formData.label"}})],1),t("el-form-item",{attrs:{label:e.$t("message.维度表名称"),prop:"name"}},[t("el-input",{attrs:{disabled:e.dialogUpdating},on:{input:e.on_input_name},model:{value:e.formData.name,callback:function(t){e.$set(e.formData,"name",t)},expression:"formData.name"}},[t("template",{slot:"prepend"},[e._v(e._s(e.DIM_PRIFIX))])],2)],1),t("el-form-item",{attrs:{label:e.$t("message.备注"),prop:"memo"}},[t("el-input",{attrs:{type:"textarea"},model:{value:e.formData.memo,callback:function(t){e.$set(e.formData,"memo",t)},expression:"formData.memo"}})],1),t("el-form-item",{attrs:{label:e.$t("message.上传维度表")}},[t("div",{staticClass:"rowRightCenter"},[t("el-upload",{attrs:{action:"",accept:".xlsx, .xls, .csv","auto-upload":!1,"show-file-list":!0,"file-list":e.fileList,limit:1,"on-change":e.handleUploadExcel}},[t("el-button",{attrs:{type:"primary",size:"small"}},[e._v(e._s(e.$t("message.点击上传excel")))]),e.dialogUpdating?t("el-button",{staticClass:"ml15",attrs:{type:"primary",size:"small"},on:{click:[function(t){return e.exportDimTable(e.editingTableData)},function(e){e.stopPropagation()}]}},[e._v(e._s(e.$t("message.点击下载")))]):e._e()],1)],1)])],1),t("div",[e.dialogUpdating?t("b-message",{staticStyle:{"font-size":"12px"}},[e._v(" 1. "+e._s(e.$t("message.维度表第1列默认为主键列"))+" "),t("br"),e._v(" 2. "+e._s(e.$t("message.更新维度表，仅能增加列，不能删除原有列"))+" ")]):t("b-message",{staticStyle:{"font-size":"12px"}},[e._v(" 1. "+e._s(e.$t("message.维度表第1列默认为主键列"))+" ")]),t("b-steps",{attrs:{size:"is-small",animated:e.isAnimated,rounded:e.isRounded,"has-navigation":e.hasNavigation,"icon-prev":e.prevIcon,"icon-next":e.nextIcon,"label-position":e.labelPosition,"mobile-mode":e.mobileMode},scopedSlots:e._u([{key:"navigation",fn:function({previous:a,next:i}){return[t("el-button",{attrs:{disabled:a.disabled},on:{click:function(t){return t.preventDefault(),e.previousStep(a)}}},[e._v(e._s(e.$t("message.上一步")))]),t("el-button",{attrs:{disabled:i.disabled},on:{click:function(t){return t.preventDefault(),e.nextStep(i)}}},[e._v(e._s(e.$t("message.下一步")))]),2==e.activeStep?t("el-button",{on:{click:function(t){e.dialogVisible=!1}}},[e._v(e._s(e.$t("message.取 消")))]):e._e(),2==e.activeStep?t("el-button",{attrs:{type:"primary"},on:{click:e.confirm}},[e._v(e._s(e.$t("message.确 定")))]):e._e()]}}]),model:{value:e.activeStep,callback:function(t){e.activeStep=t},expression:"activeStep"}},[t("b-step-item",{attrs:{step:"1",label:e.$t("message.确定维度表结构"),clickable:e.isStepsClickable}},[t("div",{staticClass:"stepworkarea"},e._l(e.editingTableData.schema,(function(a,i){return t("div",{key:i,class:{gridContainer:!0}},[0===i?t("div",{staticClass:"grid-item grid-header"},[e._v(e._s(e.$t("message.序号")))]):e._e(),0===i?t("div",{staticClass:"grid-item grid-header"},[e._v(e._s(e.$t("message.字段名字")))]):e._e(),0===i?t("div",{staticClass:"grid-item grid-header"},[e._v(e._s(e.$t("message.显示名字")))]):e._e(),0===i?t("div",{staticClass:"grid-item grid-header"},[e._v(e._s(e.$t("message.数据类型")))]):e._e(),t("div",{staticClass:"grid-item"},[0===i?t("b-icon",{attrs:{icon:"key",size:"is-small"}}):e._e(),e._v(e._s(a.index)+" ")],1),t("div",{staticClass:"grid-item"},[e._v(e._s(a.name))]),t("el-input",{staticClass:"grid-item",attrs:{size:"small"},model:{value:a.label,callback:function(t){e.$set(a,"label",t)},expression:"coldef.label"}}),t("div",{staticClass:"grid-item"},[t("el-select",{attrs:{size:"small",placeholder:e.$t("message.请选择")},model:{value:a.primary_type,callback:function(t){e.$set(a,"primary_type",t)},expression:"coldef.primary_type"}},e._l(e.primaryDataTypeOptions,(function(e){return t("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})})),1)],1)],1)})),0)]),t("b-step-item",{attrs:{step:"2",label:e.$t("message.预览维度表数据"),clickable:e.isStepsClickable,type:{"is-success":e.isProfileSuccess}}},[t("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"stepworkarea"},[t("el-table",{staticStyle:{width:"100%"},attrs:{border:"",data:e.editingTableData.rows}},e._l(e.editingTableData.schema,(function(e,a){return t("el-table-column",{key:a,attrs:{sortable:"",prop:e.name,label:e.label}})})),1)],1)]),t("b-step-item",{attrs:{step:"3",label:e.$t("message.完成"),clickable:e.isStepsClickable,disabled:""}},[t("div",{staticClass:"stepworkarea"})])],1)],1)],1)],1)},s=[],l=(a(57658),a(47056)),r=a(794),n=a(97499),o=a.n(n),m=a(11115),p=a(63822);const c=a(36797);var d={components:{},data(){const e=(e,t,a)=>{if(o().isAlphanumeric(t))return a();a(new Error(this.$t("message.维度表名字, 2至20个字母或数字组合")))};return{DIM_PRIFIX:"dim_",dialogTitle:"",dialogVisible:!1,tableData:[],status:"list",fileList:[],propColsVisible:{dim_name:{title:this.$t("message.维度表名字"),display:!0},link_prop:{title:this.$t("message.关联属性-维度表"),display:!0},label:{title:this.$t("message.维度别名"),display:!0},memo:{title:this.$t("message.备注"),display:!0},update_time:{title:this.$t("message.更新时间"),display:!0}},formData:{name:"",label:"",memo:"",schema:[],rows:[]},editingTableData:{schema:[],rows:[]},primaryKeySchemaItem:{},loading:!1,rules:{name:[{required:!0,message:this.$t("message.维度表名字, 2至20个字母或数字组合"),trigger:"blur"},{validator:e,trigger:"blur"}]},primaryDataTypeOptions:[],activeStep:0,isAnimated:!0,isRounded:!0,isStepsClickable:!1,hasNavigation:!0,isProfileSuccess:!1,prevIcon:"chevron-left",nextIcon:"chevron-right",labelPosition:"bottom",mobileMode:"minimalist"}},mounted(){this.listDimTable(),this.primaryDataTypeOptions=r.Z.def.PrimaryDataType.getOptions()},methods:{confirm(){0!==this.editingTableData.schema.length?0!==this.editingTableData.rows.length?(this.activeStep=0,this.$refs["formName"].validate((e=>e?(l.Z["new"]().createDimTable({app_id:this.getCurrAppId(),dim_name:this.DIM_PRIFIX+this.formData.name,label:this.formData.label,memo:this.formData.memo,dims:this.editingTableData.rows,schema:this.editingTableData.schema}).then(function(e){r.Z.utils.Ignore(e),this.dialogVisible=!1,this.status="list",this.listDimTable()}.bind(this)).catch(function(e){r.Z.utils.Warn(this,e)}.bind(this)),!1):(r.Z.utils.Warn(this,this.$t("message.表单参数有误")),!1)))):r.Z.utils.Warn(this,this.$t("message.维度表数据不能为空")):r.Z.utils.Warn(this,this.$t("message.维度表定义不能为空"))},listDimTable(){this.tableData=[];var e=this.getCurrAppId();l.Z["new"]().listDimTable({app_id:e}).then(function(e){var t=e.data;if(t)for(var a=0;a<t.length;a++){var i={dim_name:t[a].dim_name,link_prop:t[a].link_prop,label:t[a].label,memo:t[a].memo,update_time:t[a].update_time,schema:t[a].schema};i.update_time=c(1e3*i.update_time).format("YYYY-MM-DD");for(var s=0;s<i.link_prop.length;s++)i.link_prop[s].icon=r.Z.def.TableType.getIcon(i.link_prop[s].table_type),i.link_prop[s].label&&i.link_prop[s].label.length>0&&(i.link_prop[s].name=i.link_prop[s].label);this.tableData.push(i)}}.bind(this)).catch((e=>r.Z.utils.Err(this,e)))},loadDimTable(e){var t=this.getCurrAppId();return l.Z["new"]().getDimTable({app_id:t,dim_name:e}).then(function(e){var t=e.data.rows;t&&(this.editingTableData.rows=t)}.bind(this)).catch(function(e){r.Z.utils.Err(this,e)}.bind(this)).finally(function(){this.loading=!1}.bind(this))},previousStep(e){e.action()},nextStep(e){e.action()},on_input_name(){this.$forceUpdate()},on_change_name(){if(!this.dialogUpdating&&this.formData&&this.formData.label){var e=(0,m.ZP)(this.formData.label,{style:m.ZP.STYLE_FIRST_LETTER});this.formData.name=String(e.join(""))}},mergeDimTable(e,t){console.log(e,t)},deleteDimTable(e){l.Z["new"]().deleteDimTable({app_id:this.getCurrAppId(),dim_name:e.dim_name}).then(function(e){r.Z.utils.Ignore(e),this.listDimTable()}.bind(this)).catch(function(e){r.Z.utils.Warn(this,e)}.bind(this))},exportDimTable(e){var t={schema:e.schema,rows:e.rows};r.Z.excel.ExportDimTableExcel(t,e.dim_name+".xls")},displayNewDialog(){this.clearFileList(),this.status="new",this.dialogTitle=this.$t("message.新增维度表"),this.formData={},this.editingTableData={schema:[],rows:[]},this.dialogVisible=!0},displayEditDialog(e){this.clearFileList(),this.status="edit",this.dialogTitle=this.$t("message.更新维度表"),this.formData=e,this.formData.name=e.dim_name.replace(this.DIM_PRIFIX,""),this.editingTableData={schema:r.Z.utils.DeepClone(e.schema),rows:r.Z.utils.DeepClone(e.rows)},this.dialogVisible=!0,this.loading=!0,l.Z["new"]().getDimTable({app_id:this.getCurrAppId(),dim_name:this.formData.dim_name}).then(function(e){var t=e.data.rows;t&&(this.editingTableData.rows=t)}.bind(this)).catch(function(e){r.Z.utils.Err(this,e)}.bind(this)).finally(function(){this.loading=!1}.bind(this))},clearFileList(){this.fileList=[]},readFile(e){return new Promise((t=>{let a=new FileReader;a.readAsBinaryString(e),a.onload=e=>{t(e.target.result)}}))},async handleUploadExcel(e){let t=e.raw;if(this.dialogUpdating&&(this.editingTableData={schema:r.Z.utils.DeepClone(this.formData.schema),rows:r.Z.utils.DeepClone(this.formData.rows)}),t){let e=await this.readFile(t);var a=r.Z.excel.ParseDimTableExcel(e),i=this.getMissedCol(a);if(!r.Z.utils.IsEmptyStr(i.message))return r.Z.utils.Warn(this,i.message),void(this.fileList=[]);a=this.patchLabelWithDetailSechma(a);var s=this.checkDuplicatedFields(a.schema);if(!r.Z.utils.IsEmptyStr(s))return r.Z.utils.Warn(this,s),void(this.fileList=[]);a.schema.forEach((e=>{var t=r.Z.utils.IsValidEnglishName(e.name);t&&r.Z.utils.Warn(this,t)})),a.schema&&this.checkSchemaLabel(a.schema),this.editingTableData=a,this.activeStep=0}else r.Z.utils.Warn(this,this.$t("message.文件打开失败"))},checkSchemaLabel(e){e.forEach((e=>{e.label=r.Z.utils.ParseStrSafe(e.label),r.Z.utils.IsEmptyStr(e.label)&&(e.label=r.Z.utils.ParseStrSafe(e.name))}))},patchLabelWithDetailSechma(e){if(this.dialogUpdating)for(var t=0;t<this.formData.schema.length;t++)for(var a=0;a<e.schema.length;a++)if(e.schema[a].name===this.formData.schema[t].name){e.schema[a].label=this.formData.schema[t].label;break}return e},checkDuplicatedFields(e){for(var t={},a=0;a<e.length;a++){if(!r.Z.utils.IsEmptyStr(t[e[a].name]))return this.$t("message.字段{name}出现重复",{name:e[a].name});t[e[a].name]=e[a].name}},getMissedCol(e){var t={};if(!this.dialogUpdating)return{};for(var a=0;a<this.formData.schema.length;a++){for(var i=!1,s=0;s<e.schema.length;s++)if(e.schema[s].name===this.formData.schema[a].name){if(e.schema[s].primary_type!==this.formData.schema[a].primary_type)return t=this.formData.schema[a],t.message=this.$t("message.数据列{name},不能变更原有数据类型{type}",{name:t.name,type:r.Z.def.PrimaryDataType.getZhLabel(e.schema[s].primary_type)}),t;i=!0;break}if(!i)return t=this.formData.schema[a],t.message=this.$t("message.缺少数据列")+t.name,t}return{}}},computed:{...(0,p.Se)({getCurrAppId:"system/getCurrAppId"}),dialogUpdating:function(){return"edit"==this.status}}},h=d,b=a(1001),u=(0,b.Z)(h,i,s,!1,null,"487ccbf0",null),g=u.exports}}]);